-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- Variables
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

print("Script started - Player found:", player.Name)

-- Configuration
local MAX_INVENTORY_SIZE = 235 -- When inventory reaches this ‚Üí Go to Plaza
local RETURN_THRESHOLD = 100 -- When inventory drops to this or below in Plaza ‚Üí Return to Garden
local AUTO_TELEPORT = true -- Set to false to disable automation

-- Wait for character
local character = player.Character or player.CharacterAdded:Wait()
local backpack = player:WaitForChild("Backpack")

print("Character and backpack loaded")

-- Find the remotes
local plazaRemote
local mainWorldRemote

local success = pcall(function()
    plazaRemote = ReplicatedStorage:WaitForChild("GameEvents", 10)
        :WaitForChild("TradeWorld", 10)
        :WaitForChild("TravelToTradeWorld", 10)
end)

local successMain = pcall(function()
    mainWorldRemote = ReplicatedStorage:WaitForChild("GameEvents", 10)
        :WaitForChild("TradeWorld", 10)
        :WaitForChild("TravelToMainWorld", 10)
end)

if plazaRemote then
    print("‚úÖ Plaza Remote found:", plazaRemote:GetFullName())
else
    warn("‚ùå Plaza Remote not found")
end

if mainWorldRemote then
    print("‚úÖ Main World Remote found:", mainWorldRemote:GetFullName())
else
    warn("‚ùå Main World Remote not found")
end

-- Teleport control
local joinInProgress = false
local currentLocation = "Unknown" -- Will be detected on startup

-- ONE-TIME TELEPORT SYSTEM
local hasAutoTeleportedToPlaza = false 
local hasAutoTeleportedFromPlaza = false 

-- Clean up any existing version of this GUI
if playerGui:FindFirstChild("InventoryTeleportGui") then
    playerGui.InventoryTeleportGui:Destroy()
end

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "InventoryTeleportGui"
screenGui.ResetOnSpawn = false
screenGui.Enabled = true
screenGui.Parent = playerGui

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 280, 0, 210)
mainFrame.Position = UDim2.new(0.5, -140, 0.1, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainFrame.BorderSizePixel = 2
mainFrame.BorderColor3 = Color3.fromRGB(255, 170, 0)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = mainFrame

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0, 30)
titleLabel.Position = UDim2.new(0, 0, 0, 0)
titleLabel.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
titleLabel.BorderSizePixel = 0
titleLabel.Text = "Auto Inventory Teleport"
titleLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
titleLabel.TextSize = 16
titleLabel.Font = Enum.Font.GothamBold
titleLabel.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = titleLabel

-- Close Button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 28, 0, 20)
closeButton.Position = UDim2.new(1, -34, 0, 5)
closeButton.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
closeButton.BorderSizePixel = 0
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextSize = 14
closeButton.Font = Enum.Font.GothamBold
closeButton.Parent = mainFrame

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 6)
closeCorner.Parent = closeButton

-- Inventory Label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 25)
statusLabel.Position = UDim2.new(0, 10, 0, 40)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Inventory: 0/" .. MAX_INVENTORY_SIZE
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
statusLabel.TextSize = 14
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

-- Location Label
local locationLabel = Instance.new("TextLabel")
locationLabel.Size = UDim2.new(1, -20, 0, 20)
locationLabel.Position = UDim2.new(0, 10, 0, 65)
locationLabel.BackgroundTransparency = 1
locationLabel.Text = "üìç Location: Detecting..."
locationLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
locationLabel.TextSize = 12
locationLabel.Font = Enum.Font.GothamBold
locationLabel.TextXAlignment = Enum.TextXAlignment.Left
locationLabel.Parent = mainFrame

-- Auto Status Label
local autoStatusLabel = Instance.new("TextLabel")
autoStatusLabel.Size = UDim2.new(1, -20, 0, 18)
autoStatusLabel.Position = UDim2.new(0, 10, 0, 85)
autoStatusLabel.BackgroundTransparency = 1
autoStatusLabel.Text = "‚öôÔ∏è Auto: Monitoring..."
autoStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
autoStatusLabel.TextSize = 10
autoStatusLabel.Font = Enum.Font.Gotham
autoStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
autoStatusLabel.Parent = mainFrame

-- Teleport to Plaza Button
local teleportButton = Instance.new("TextButton")
teleportButton.Size = UDim2.new(0, 250, 0, 35)
teleportButton.Position = UDim2.new(0, 15, 0, 110)
teleportButton.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
teleportButton.BorderSizePixel = 0
teleportButton.Text = "Teleport to Plaza"
teleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
teleportButton.TextSize = 14
teleportButton.Font = Enum.Font.GothamBold
teleportButton.Parent = mainFrame

local teleportCorner = Instance.new("UICorner")
teleportCorner.CornerRadius = UDim.new(0, 6)
teleportCorner.Parent = teleportButton

-- Return to Garden Button
local returnButton = Instance.new("TextButton")
returnButton.Size = UDim2.new(0, 250, 0, 35)
returnButton.Position = UDim2.new(0, 15, 0, 155)
returnButton.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
returnButton.BorderSizePixel = 0
returnButton.Text = "Return to Garden"
returnButton.TextColor3 = Color3.fromRGB(255, 255, 255)
returnButton.TextSize = 14
returnButton.Font = Enum.Font.GothamBold
returnButton.Parent = mainFrame

local returnCorner = Instance.new("UICorner")
returnCorner.CornerRadius = UDim.new(0, 6)
returnCorner.Parent = returnButton

print("GUI created successfully")

-- ENHANCED LOCATION DETECTION FUNCTION
local function detectCurrentLocation()
    if Workspace:FindFirstChild("Plaza") or Workspace:FindFirstChild("TradeWorld") then
        return "Plaza"
    end
    
    if Workspace:FindFirstChild("Garden") or Workspace:FindFirstChild("MainWorld") or Workspace:FindFirstChild("Map") then
        return "Garden"
    end
    
    if character and character.PrimaryPart then
        local yPos = character.PrimaryPart.Position.Y
        if yPos > 500 then
            return "Plaza"
        else
            return "Garden"
        end
    end
    
    for _, obj in pairs(Workspace:GetDescendants()) do
        local name = obj.Name:lower()
        if name:find("trader") or name:find("tradeshop") or name:find("plaza") then
            return "Plaza"
        end
        if name:find("plant") or name:find("farm") or name:find("garden") then
            return "Garden"
        end
    end
    
    return "Garden"
end

local function updateLocation()
    local newLocation = detectCurrentLocation()
    if newLocation ~= currentLocation then
        print("üîÑ Location changed:", currentLocation, "‚Üí", newLocation)
        currentLocation = newLocation
        updateGui()
    end
end

-- ==========================================
-- ‚úÖ INTEGRATED PET COUNTER FUNCTION
-- ==========================================
local function getInventoryCount()
    local count = 0
    local OFFSET = 8 -- <--- Here is the +8 offset to fix the game's hidden pets!
    
    -- Deep search the entire Player object
    for _, item in ipairs(player:GetDescendants()) do
        if item.Name == "PetToolLocal" then
            count = count + 1
        end
    end
    
    -- Deep search the Character (for physically equipped pets)
    if character then
        for _, item in ipairs(character:GetDescendants()) do
            if item.Name == "PetToolLocal" then
                count = count + 1
            end
        end
    end
    
    return count + OFFSET
end

local function isInventoryFull()
    return getInventoryCount() >= MAX_INVENTORY_SIZE
end

-- UPDATE GUI FUNCTION
function updateGui()
    local currentCount = getInventoryCount()
    statusLabel.Text = "Inventory: " .. currentCount .. "/" .. MAX_INVENTORY_SIZE
    
    -- Update location display
    if currentLocation == "Plaza" then
        locationLabel.Text = "üìç Location: Plaza (Trade World)"
        locationLabel.TextColor3 = Color3.fromRGB(100, 150, 255)
    elseif currentLocation == "Garden" then
        locationLabel.Text = "üìç Location: Garden (Main World)"
        locationLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    else
        locationLabel.Text = "üìç Location: " .. currentLocation
        locationLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
    end
    
    -- Update inventory status
    if isInventoryFull() then
        statusLabel.TextColor3 = Color3.fromRGB(255, 85, 85)
        if currentLocation ~= "Plaza" then
            teleportButton.BackgroundColor3 = Color3.fromRGB(255, 85, 85)
            teleportButton.Text = "INVENTORY FULL - GO TO PLAZA!"
        else
            teleportButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
            teleportButton.Text = "Already in Plaza"
        end
    else
        statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        if currentLocation ~= "Plaza" then
            teleportButton.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
            teleportButton.Text = "Teleport to Plaza"
        else
            teleportButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
            teleportButton.Text = "Already in Plaza"
        end
    end
    
    -- Update return button based on location
    if currentLocation == "Garden" then
        returnButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
        returnButton.Text = "Already in Garden"
    else
        returnButton.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
        returnButton.Text = "Return to Garden"
    end
    
    -- Update auto-status
    if currentLocation == "Garden" then
        if currentCount >= MAX_INVENTORY_SIZE and not hasAutoTeleportedToPlaza then
            autoStatusLabel.Text = "‚öôÔ∏è Auto: Ready to go to Plaza (1x)"
            autoStatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        elseif currentCount >= MAX_INVENTORY_SIZE and hasAutoTeleportedToPlaza then
            autoStatusLabel.Text = "‚öôÔ∏è Auto: Used (manual teleport only)"
            autoStatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        else
            autoStatusLabel.Text = "‚öôÔ∏è Auto: Farming... (" .. currentCount .. "/" .. MAX_INVENTORY_SIZE .. ")"
            autoStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        end
    elseif currentLocation == "Plaza" then
        if currentCount <= RETURN_THRESHOLD and not hasAutoTeleportedFromPlaza then
            autoStatusLabel.Text = "‚öôÔ∏è Auto: Ready to return to Garden (1x)"
            autoStatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        elseif currentCount <= RETURN_THRESHOLD and hasAutoTeleportedFromPlaza then
            autoStatusLabel.Text = "‚öôÔ∏è Auto: Used (manual teleport only)"
            autoStatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        else
            autoStatusLabel.Text = "‚öôÔ∏è Auto: Trading... (" .. currentCount .. " > " .. RETURN_THRESHOLD .. ")"
            autoStatusLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
        end
    end
end

-- TELEPORT FUNCTIONS
local function teleportToPlaza()
    if currentLocation == "Plaza" then
        print("‚ÑπÔ∏è Already in Plaza - skipping teleport")
        teleportButton.Text = "Already in Plaza"
        teleportButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
        task.wait(1.5)
        updateGui()
        return
    end
    
    if joinInProgress then
        print("‚è≥ Teleport already in progress")
        return
    end
    
    if not plazaRemote then
        warn("‚ùå Plaza remote not found!")
        return
    end
    
    joinInProgress = true
    teleportButton.Text = "Teleporting to Plaza..."
    teleportButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
    
    local success, err = pcall(function()
        plazaRemote:FireServer()
    end)
    
    if success then
        print("‚úÖ Teleport request sent to Plaza!")
    else
        warn("‚ùå Teleport error:", err)
        task.wait(2)
        joinInProgress = false
        updateGui()
    end
end

local function teleportToGarden()
    if currentLocation == "Garden" then
        print("‚ÑπÔ∏è Already in Garden - skipping teleport")
        returnButton.Text = "Already in Garden"
        returnButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
        task.wait(1.5)
        updateGui()
        return
    end
    
    if joinInProgress then
        print("‚è≥ Teleport already in progress")
        return
    end
    
    if not mainWorldRemote then
        warn("‚ùå Garden remote not found!")
        return
    end
    
    joinInProgress = true
    returnButton.Text = "Returning to Garden..."
    returnButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
    
    local success, err = pcall(function()
        mainWorldRemote:FireServer()
    end)
    
    if success then
        print("‚úÖ Teleport request sent to Garden!")
    else
        warn("‚ùå Teleport error:", err)
        task.wait(2)
        joinInProgress = false
        updateGui()
    end
end

-- BUTTON EVENTS
teleportButton.MouseButton1Click:Connect(function()
    teleportToPlaza()
end)

returnButton.MouseButton1Click:Connect(function()
    teleportToGarden()
end)

closeButton.MouseButton1Click:Connect(function()
    screenGui.Enabled = false
    print("GUI closed")
end)

-- BACKPACK MONITORING
if backpack then
    backpack.ChildAdded:Connect(function(child)
        updateGui()
    end)
    
    backpack.ChildRemoved:Connect(function(child)
        updateGui()
    end)
end

-- CHARACTER RESPAWN
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    backpack = player:WaitForChild("Backpack")
    task.wait(2)
    updateLocation()
    print("üîÑ Character respawned - Location:", currentLocation)
    updateGui()
end)

-- Continuous location monitoring
task.spawn(function()
    while true do
        task.wait(3)
        updateLocation()
    end
end)

-- INITIAL SETUP
task.wait(2)
currentLocation = detectCurrentLocation()
print("üéÆ Initial location detected:", currentLocation)
print("üì¶ Initial inventory:", getInventoryCount())
updateGui()

-- MAIN AUTO-TELEPORT LOOP
task.spawn(function()
    while AUTO_TELEPORT do
        task.wait(2)
        updateLocation()
        
        local currentInventory = getInventoryCount()
        
        if currentLocation == "Garden" and currentInventory >= MAX_INVENTORY_SIZE and not hasAutoTeleportedToPlaza then
            print("üö® TRIGGER: Inventory FULL in Garden ‚Üí Going to Plaza")
            hasAutoTeleportedToPlaza = true
            teleportToPlaza()
        end
        
        if currentLocation == "Plaza" and currentInventory <= RETURN_THRESHOLD and not hasAutoTeleportedFromPlaza then
            print("üå± TRIGGER: Inventory ‚â§" .. RETURN_THRESHOLD .. " in Plaza ‚Üí Returning to Garden")
            hasAutoTeleportedFromPlaza = true
            teleportToGarden()
        end
        
        updateGui()
    end
end)

print("=== ‚úÖ AUTO INVENTORY TELEPORT LOADED ===")
